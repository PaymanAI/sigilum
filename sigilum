#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CLR_RESET=""
CLR_BOLD=""
CLR_DIM=""
CLR_YELLOW=""
CLR_CYAN=""

setup_colors() {
  if [[ -t 1 && -z "${NO_COLOR:-}" && "${TERM:-}" != "dumb" ]]; then
    CLR_RESET=$'\033[0m'
    CLR_BOLD=$'\033[1m'
    CLR_DIM=$'\033[2m'
    CLR_YELLOW=$'\033[33m'
    CLR_CYAN=$'\033[36m'
  fi
}

setup_colors

print_version() {
  if [[ -f "$ROOT_DIR/VERSION" ]]; then
    printf 'sigilum %s\n' "$(cat "$ROOT_DIR/VERSION")"
  else
    printf 'sigilum (development)\n'
  fi
}

usage() {
  cat <<USAGE
${CLR_BOLD}${CLR_YELLOW}✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧${CLR_RESET}
${CLR_BOLD}${CLR_YELLOW}✧${CLR_RESET}                  ${CLR_BOLD}${CLR_YELLOW}✧${CLR_RESET} ${CLR_BOLD}S I G I L U M${CLR_YELLOW}.${CLR_RESET}                        ${CLR_BOLD}${CLR_YELLOW}✧${CLR_RESET}
${CLR_BOLD}${CLR_YELLOW}✧${CLR_RESET}            ${CLR_DIM}Auditable Identity for AI Agents${CLR_RESET}              ${CLR_BOLD}${CLR_YELLOW}✧${CLR_RESET}
${CLR_BOLD}${CLR_YELLOW}✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧✧${CLR_RESET}

${CLR_BOLD}${CLR_CYAN}Usage:${CLR_RESET}
  ${CLR_BOLD}sigilum${CLR_RESET} ${CLR_DIM}[global options] <command> [args]${CLR_RESET}

${CLR_BOLD}${CLR_CYAN}Global options:${CLR_RESET}
  ${CLR_BOLD}--namespace <value>${CLR_RESET}            ${CLR_DIM}Set GATEWAY_SIGILUM_NAMESPACE${CLR_RESET}
  ${CLR_BOLD}--sigilum-home <path>${CLR_RESET}          ${CLR_DIM}Set GATEWAY_SIGILUM_HOME${CLR_RESET}
  ${CLR_BOLD}--gateway-admin-url <url>${CLR_RESET}      ${CLR_DIM}Set GATEWAY_ADMIN_URL${CLR_RESET}
  ${CLR_BOLD}--gateway-data-dir <path>${CLR_RESET}      ${CLR_DIM}Set GATEWAY_DATA_DIR${CLR_RESET}
  ${CLR_BOLD}--gateway-master-key <value>${CLR_RESET}   ${CLR_DIM}Set GATEWAY_MASTER_KEY${CLR_RESET}
  ${CLR_BOLD}-v, --version${CLR_RESET}                  ${CLR_DIM}Show version${CLR_RESET}
  ${CLR_BOLD}--api-port <port>${CLR_RESET}              ${CLR_DIM}Set API_PORT${CLR_RESET}
  ${CLR_BOLD}--gateway-port <port>${CLR_RESET}          ${CLR_DIM}Set GATEWAY_PORT${CLR_RESET}
  ${CLR_BOLD}--native-port <port>${CLR_RESET}           ${CLR_DIM}Set NATIVE_PORT${CLR_RESET}
  ${CLR_BOLD}--upstream-port <port>${CLR_RESET}         ${CLR_DIM}Set UPSTREAM_PORT${CLR_RESET}
  ${CLR_BOLD}-h, --help${CLR_RESET}                     ${CLR_DIM}Show help${CLR_RESET}

${CLR_BOLD}${CLR_CYAN}Commands:${CLR_RESET}
  ${CLR_BOLD}install${CLR_RESET} [options]              ${CLR_DIM}Install sigilum command into your shell (symlink/alias)${CLR_RESET}
  ${CLR_BOLD}auth${CLR_RESET} <args>                    ${CLR_DIM}Manage namespace-owner auth token bootstrap (login/refresh)${CLR_RESET}
  ${CLR_BOLD}login${CLR_RESET} [options]                ${CLR_DIM}Alias for: sigilum auth login${CLR_RESET}
  ${CLR_BOLD}gateway${CLR_RESET} <args>                 ${CLR_DIM}Gateway pairing helpers (local bridge for managed dashboard)${CLR_RESET}
  ${CLR_BOLD}openclaw${CLR_RESET} <args>                ${CLR_DIM}Manage OpenClaw integration (install/uninstall/status)${CLR_RESET}
  ${CLR_BOLD}service${CLR_RESET} <args>                 ${CLR_DIM}Manage local services (delegates to scripts/sigilum-service.sh)${CLR_RESET}
  ${CLR_BOLD}doctor${CLR_RESET}                         ${CLR_DIM}Validate local setup, security posture, and runtime readiness${CLR_RESET}
  ${CLR_BOLD}up${CLR_RESET}                             ${CLR_DIM}Start local API + gateway (scripts/run-local-api-gateway.sh)${CLR_RESET}
  ${CLR_BOLD}down${CLR_RESET}                           ${CLR_DIM}Stop local API/gateway/demo listeners on known ports${CLR_RESET}
  ${CLR_BOLD}e2e-tests${CLR_RESET}                      ${CLR_DIM}Start demo services and run end-to-end tests${CLR_RESET}
  ${CLR_BOLD}agent-simulator${CLR_RESET}                ${CLR_DIM}Run agent auth simulator against running services${CLR_RESET}
  ${CLR_BOLD}help${CLR_RESET} [command]                 ${CLR_DIM}Show top-level or command-specific help${CLR_RESET}

${CLR_BOLD}${CLR_CYAN}Examples:${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum install${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum auth login --mode oss-local --namespace johndee${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum auth refresh --mode oss-local --namespace johndee${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum gateway pair --session-id <id> --pair-code <code> --namespace johndee${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum openclaw --help${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum openclaw install --help${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum openclaw install --namespace johndee --mode oss-local${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum openclaw install --namespace johndee --mode managed${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum openclaw uninstall${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum help openclaw${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum doctor${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum up${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum down${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum service add --service-slug demo-native --mode native${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum service list --namespace johndee${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum service secret set --service-slug linear --upstream-secret-env LINEAR_TOKEN${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum service add --service-slug demo-proxy --mode gateway --upstream-base-url http://127.0.0.1:12000${CLR_RESET}
  ${CLR_BOLD}${CLR_YELLOW}sigilum e2e-tests${CLR_RESET}
USAGE
}

ensure_script() {
  local script_path="$1"
  if [[ ! -x "$script_path" ]]; then
    echo "Missing executable script: $script_path" >&2
    exit 1
  fi
}

export_if_set() {
  local name="$1"
  local value="$2"
  if [[ -n "$value" ]]; then
    export "$name=$value"
  fi
}

trim() {
  local value="${1:-}"
  value="${value#"${value%%[![:space:]]*}"}"
  value="${value%"${value##*[![:space:]]}"}"
  printf '%s' "$value"
}

default_sigilum_config_file() {
  local config_home="${SIGILUM_CONFIG_HOME:-$HOME/.sigilum}"
  local config_file="${SIGILUM_CONFIG_FILE:-${config_home}/config.env}"
  printf '%s' "$config_file"
}

read_env_file_value() {
  local file_path="$1"
  local key="$2"
  local line lhs rhs first_char last_char

  [[ -f "$file_path" ]] || return 1

  while IFS= read -r line || [[ -n "$line" ]]; do
    line="${line%$'\r'}"
    [[ "$line" == *"="* ]] || continue

    lhs="$(trim "${line%%=*}")"
    [[ -n "$lhs" ]] || continue
    [[ "${lhs:0:1}" != "#" ]] || continue
    [[ "$lhs" == "$key" ]] || continue

    rhs="$(trim "${line#*=}")"
    if [[ ${#rhs} -ge 2 ]]; then
      first_char="${rhs:0:1}"
      last_char="${rhs: -1}"
      if [[ "$first_char" == "\"" && "$last_char" == "\"" ]]; then
        rhs="${rhs:1:${#rhs}-2}"
      elif [[ "$first_char" == "'" && "$last_char" == "'" ]]; then
        rhs="${rhs:1:${#rhs}-2}"
      fi
    fi

    printf '%s' "$rhs"
    return 0
  done < "$file_path"

  return 1
}

load_persisted_namespace_defaults() {
  if [[ -n "${GATEWAY_SIGILUM_NAMESPACE:-}" || -n "${SIGILUM_NAMESPACE:-}" ]]; then
    return 0
  fi

  local config_file persisted_namespace
  config_file="$(default_sigilum_config_file)"
  [[ -f "$config_file" ]] || return 0

  persisted_namespace="$(read_env_file_value "$config_file" "GATEWAY_SIGILUM_NAMESPACE" || true)"
  if [[ -z "$persisted_namespace" ]]; then
    persisted_namespace="$(read_env_file_value "$config_file" "SIGILUM_NAMESPACE" || true)"
  fi
  persisted_namespace="$(trim "$persisted_namespace")"
  if [[ -n "$persisted_namespace" ]]; then
    export GATEWAY_SIGILUM_NAMESPACE="$persisted_namespace"
    export SIGILUM_NAMESPACE="$persisted_namespace"
  fi
}

detect_openclaw_namespace() {
  local openclaw_home="${OPENCLAW_HOME:-$HOME/.openclaw}"
  local config_path="${OPENCLAW_CONFIG_PATH:-${openclaw_home}/openclaw.json}"
  if [[ ! -f "$config_path" ]]; then
    return 0
  fi
  node - "$config_path" <<'NODE'
const fs = require("node:fs");
const path = (process.argv[2] || "").trim();
if (!path) process.exit(0);
try {
  const raw = fs.readFileSync(path, "utf8");
  const parsed = JSON.parse(raw);
  const hooks = parsed?.hooks?.internal?.entries?.["sigilum-plugin"]?.env;
  const namespace = typeof hooks?.SIGILUM_NAMESPACE === "string"
    ? hooks.SIGILUM_NAMESPACE.trim()
    : "";
  if (namespace) process.stdout.write(namespace);
} catch {
  // best-effort detection only
}
NODE
}

resolve_namespace_for_up() {
  if [[ -n "${GATEWAY_SIGILUM_NAMESPACE:-}" ]]; then
    export SIGILUM_NAMESPACE="${SIGILUM_NAMESPACE:-$GATEWAY_SIGILUM_NAMESPACE}"
    return 0
  fi

  if [[ -n "${SIGILUM_NAMESPACE:-}" ]]; then
    export GATEWAY_SIGILUM_NAMESPACE="$SIGILUM_NAMESPACE"
    return 0
  fi

  local detected_namespace
  detected_namespace="$(detect_openclaw_namespace)"
  if [[ -n "$detected_namespace" ]]; then
    export GATEWAY_SIGILUM_NAMESPACE="$detected_namespace"
    export SIGILUM_NAMESPACE="$detected_namespace"
  fi
}

NAMESPACE=""
SIGILUM_HOME=""
GATEWAY_ADMIN_URL_OPT=""
GATEWAY_DATA_DIR_OPT=""
GATEWAY_MASTER_KEY_OPT=""
API_PORT_OPT=""
GATEWAY_PORT_OPT=""
NATIVE_PORT_OPT=""
UPSTREAM_PORT_OPT=""

load_persisted_namespace_defaults

while [[ $# -gt 0 ]]; do
  case "$1" in
    --namespace)
      NAMESPACE="${2:-}"
      shift 2
      ;;
    --sigilum-home)
      SIGILUM_HOME="${2:-}"
      shift 2
      ;;
    --gateway-admin-url)
      GATEWAY_ADMIN_URL_OPT="${2:-}"
      shift 2
      ;;
    --gateway-data-dir)
      GATEWAY_DATA_DIR_OPT="${2:-}"
      shift 2
      ;;
    --gateway-master-key)
      GATEWAY_MASTER_KEY_OPT="${2:-}"
      shift 2
      ;;
    --api-port)
      API_PORT_OPT="${2:-}"
      shift 2
      ;;
    --gateway-port)
      GATEWAY_PORT_OPT="${2:-}"
      shift 2
      ;;
    --native-port)
      NATIVE_PORT_OPT="${2:-}"
      shift 2
      ;;
    --upstream-port)
      UPSTREAM_PORT_OPT="${2:-}"
      shift 2
      ;;
    --version|-v)
      print_version
      exit 0
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

export_if_set "GATEWAY_SIGILUM_NAMESPACE" "$NAMESPACE"
export_if_set "SIGILUM_NAMESPACE" "$NAMESPACE"
export_if_set "GATEWAY_SIGILUM_HOME" "$SIGILUM_HOME"
export_if_set "GATEWAY_ADMIN_URL" "$GATEWAY_ADMIN_URL_OPT"
export_if_set "GATEWAY_DATA_DIR" "$GATEWAY_DATA_DIR_OPT"
export_if_set "GATEWAY_MASTER_KEY" "$GATEWAY_MASTER_KEY_OPT"
export_if_set "API_PORT" "$API_PORT_OPT"
export_if_set "GATEWAY_PORT" "$GATEWAY_PORT_OPT"
export_if_set "NATIVE_PORT" "$NATIVE_PORT_OPT"
export_if_set "UPSTREAM_PORT" "$UPSTREAM_PORT_OPT"

command="$1"
shift || true

case "$command" in
  version)
    print_version
    exit 0
    ;;
  install)
    ensure_script "$ROOT_DIR/scripts/install-sigilum.sh"
    exec "$ROOT_DIR/scripts/install-sigilum.sh" "$@"
    ;;
  openclaw)
    ensure_script "$ROOT_DIR/scripts/sigilum-openclaw.sh"
    exec "$ROOT_DIR/scripts/sigilum-openclaw.sh" "$@"
    ;;
  gateway)
    ensure_script "$ROOT_DIR/scripts/sigilum-gateway.sh"
    exec "$ROOT_DIR/scripts/sigilum-gateway.sh" "$@"
    ;;
  auth)
    ensure_script "$ROOT_DIR/scripts/sigilum-auth.sh"
    exec "$ROOT_DIR/scripts/sigilum-auth.sh" "$@"
    ;;
  login)
    ensure_script "$ROOT_DIR/scripts/sigilum-auth.sh"
    exec "$ROOT_DIR/scripts/sigilum-auth.sh" login "$@"
    ;;
  doctor)
    ensure_script "$ROOT_DIR/scripts/sigilum-doctor.sh"
    exec "$ROOT_DIR/scripts/sigilum-doctor.sh" "$@"
    ;;
  up)
    resolve_namespace_for_up
    ensure_script "$ROOT_DIR/scripts/run-local-api-gateway.sh"
    if [[ -n "${GATEWAY_PORT_OPT}" ]] && [[ -z "${GATEWAY_ADDR:-}" ]]; then
      export GATEWAY_ADDR=":${GATEWAY_PORT_OPT}"
    fi
    exec "$ROOT_DIR/scripts/run-local-api-gateway.sh" "$@"
    ;;
  down)
    ensure_script "$ROOT_DIR/scripts/sigilum-down.sh"
    exec "$ROOT_DIR/scripts/sigilum-down.sh" "$@"
    ;;
  e2e-tests)
    ensure_script "$ROOT_DIR/scripts/run-demo-e2e.sh"
    exec "$ROOT_DIR/scripts/run-demo-e2e.sh" "$@"
    ;;
  agent-simulator)
    if [[ -n "${API_PORT_OPT}" ]]; then
      export SIM_API_URL="http://127.0.0.1:${API_PORT_OPT}"
    fi
    if [[ -n "${GATEWAY_PORT_OPT}" ]]; then
      export SIM_GATEWAY_URL="http://127.0.0.1:${GATEWAY_PORT_OPT}"
    fi
    if [[ -n "${NATIVE_PORT_OPT}" ]]; then
      export SIM_NATIVE_URL="http://127.0.0.1:${NATIVE_PORT_OPT}"
    fi
    if [[ -n "${UPSTREAM_PORT_OPT}" ]]; then
      export SIM_GATEWAY_UPSTREAM_URL="http://127.0.0.1:${UPSTREAM_PORT_OPT}"
    fi
    exec node "$ROOT_DIR/scripts/test-agent-simulator.mjs" "$@"
    ;;
  service)
    ensure_script "$ROOT_DIR/scripts/sigilum-service.sh"
    exec "$ROOT_DIR/scripts/sigilum-service.sh" "$@"
    ;;
  help|-h|--help)
    if [[ "$command" == "help" ]] && [[ $# -gt 0 ]]; then
      topic="$1"
      shift || true
      case "$topic" in
        install)
          ensure_script "$ROOT_DIR/scripts/install-sigilum.sh"
          exec "$ROOT_DIR/scripts/install-sigilum.sh" --help "$@"
          ;;
        openclaw)
          ensure_script "$ROOT_DIR/scripts/sigilum-openclaw.sh"
          exec "$ROOT_DIR/scripts/sigilum-openclaw.sh" --help "$@"
          ;;
        auth|login)
          ensure_script "$ROOT_DIR/scripts/sigilum-auth.sh"
          exec "$ROOT_DIR/scripts/sigilum-auth.sh" --help "$@"
          ;;
        gateway)
          ensure_script "$ROOT_DIR/scripts/sigilum-gateway.sh"
          exec "$ROOT_DIR/scripts/sigilum-gateway.sh" --help "$@"
          ;;
        service)
          ensure_script "$ROOT_DIR/scripts/sigilum-service.sh"
          exec "$ROOT_DIR/scripts/sigilum-service.sh" help "$@"
          ;;
        doctor|up|down|e2e-tests|agent-simulator)
          usage
          ;;
        *)
          echo "Unknown help topic: $topic" >&2
          usage
          exit 1
          ;;
      esac
    else
      usage
    fi
    ;;
  *)
    echo "Unknown command: $command" >&2
    usage
    exit 1
    ;;
esac
